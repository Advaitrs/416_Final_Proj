<!DOCTYPE html>
<html>
<head>
  <title>Narrative Slideshow</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
</head>
<body>
  <div id="chart"></div>
  <div id="tooltip" style="position: absolute; visibility: hidden; padding: 8px; background-color: rgba(0, 0, 0, 0.8); color: #fff;"></div>
  <button onclick="previousSlide()">Previous</button>
  <button onclick="nextSlide()">Next</button>
  <button onclick="goToStart()">Go Back to Start</button>
  <script>
    // Global variables to track the current slide index
    let currentSlideIndex = 0;

    // Load the CSV data using d3.csv with d3.autoType
    Promise.all([
      d3.csv("https://advaitrs.github.io/us-states-2020.csv", d3.autoType),
      d3.csv("https://advaitrs.github.io/us-states-2021.csv", d3.autoType),
      d3.csv("https://advaitrs.github.io/us-states-2022.csv", d3.autoType),
      d3.csv("https://advaitrs.github.io/us-states-2023.csv", d3.autoType),
      d3.csv("https://advaitrs.github.io/state_parties.csv", d3.autoType)
    ]).then(function([data2020, data2021, data2022, data2023, partiesData]) {
      // Data is now parsed with appropriate types
      // Show the first slide by default
      showSlide(data2020, partiesData, "2020");
      //showSlide(data2021, partiesData, "2021");
      showSlide(data2022, partiesData, "2022");
      showSlide(data2023, partiesData, "2023");
    }).catch(function(error) {
      console.error("Error loading data:", error);
    });

    // Function to show tooltip
    function showTooltip(content) {
      const tooltip = d3.select("#tooltip");
      tooltip.text(content);
      tooltip.style("visibility", "visible");
    }

    // Function to hide tooltip
    function hideTooltip() {
      const tooltip = d3.select("#tooltip");
      tooltip.style("visibility", "hidden");
    }

    // Function to show a slide for a specific year
    function showSlide(data, partiesData, year) {

      // Add party affiliation information to the data
      data.forEach(d => {
        const partyInfo = partiesData.find(p => p.State === d.State);
        if (partyInfo) {
          d.PartyAffiliation = partyInfo["Governor Political Affiliation"];
        }
      });

      // Width and height of the chart
      const width = 600;
      const height = 400;
      const margin = { top: 30, right: 30, bottom: 70, left: 60 };
      const chartWidth = width - margin.left - margin.right;
      const chartHeight = height - margin.top - margin.bottom;

      // Create an SVG container
      const svg = d3.select("#chart")
        .append("svg")
        .attr("width", width)
        .attr("height", height);
      
      // Set colors based on affiliation (Democratic or Republican)
      const colorScale = d3.scaleOrdinal()
        .domain(["Democratic", "Republican"])
        .range(["blue", "red"]);

      // Create scales
      const xScale = d3.scaleBand()
        .domain(data.map(d => d.State))
        .range([0, chartWidth])
        .padding(0.1);

      const yScale = d3.scaleLinear()
        .domain([0, d3.max(data, d => d.Cases)])
        .range([chartHeight, 0]);

      // Create bars
      svg.selectAll("rect")
        .data(data)
        .enter()
        .append("rect")
        .attr("x", d => xScale(d.State))
        .attr("y", d => yScale(d.Cases))
        .attr("width", xScale.bandwidth())
        .attr("height", d => chartHeight - yScale(d.Cases))
        .attr("fill", d => colorScale(d.PartyAffiliation))
        .on("mouseover", function(event, d) {
          showTooltip(`State: ${d.State}, Cases: ${d.Cases}`);
        })
        .on("mouseout", function() {
          hideTooltip();
        });

      // Add x-axis
      svg.append("g")
        .attr("transform", `translate(0, ${chartHeight})`)
        .call(d3.axisBottom(xScale))
        .selectAll("text")
        .attr("transform", "rotate(-45)")
        .style("text-anchor", "end");

      // Add y-axis
      svg.append("g")
        .call(d3.axisLeft(yScale));

      // Add a title
      svg.append("text")
        .attr("x", width / 2)
        .attr("y", 30)
        .attr("text-anchor", "middle")
        .text(`COVID-19 Cases by State in ${year}`);
    }

    // Function to show the current slide based on the index
    function showCurrentSlide() {
      // Hide all slides
      d3.selectAll("#chart > svg").style("display", "none");

      // Show the current slide
      d3.select(`#chart > svg:nth-child(${currentSlideIndex + 1})`).style("display", "block");
    }

    // Function to go to the next slide
    function nextSlide() {
      currentSlideIndex = (currentSlideIndex + 1) % 4;
      showCurrentSlide();
    }

    // Function to go to the previous slide
    function previousSlide() {
      currentSlideIndex = (currentSlideIndex - 1 + 4) % 4;
      showCurrentSlide();
    }

    // Function to go back to the start
    function goToStart() {
      currentSlideIndex = 0;
      showCurrentSlide();
    }

    // Call showCurrentSlide to display the first slide on load
    showCurrentSlide();
  </script>
</body>
</html>